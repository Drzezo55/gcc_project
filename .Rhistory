install.packages("tinytex")
### load your data and create the madad object with 95% CI
setwd("~/Desktop/swab")      # macOS/Linux
df <- read_excel("Outcome.xlsx")
meta <- madad(df, level = 0.95)
install.packages("tinytex")
install.packages("tinytex")
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(mada)
### load your data and create the madad object with 95% CI
setwd("~/Desktop/swab")      # macOS/Linux
df <- read_excel("Outcome.xlsx")
meta <- madad(df, level = 0.95)
tinytex::pdflatex()
install.packages("tinytex")      # if not installed
install.packages("tinytex")
tinytex::tinytex_root()    # shows where TinyTeX is installed
tinytex::latexmk("test.tex")
# Install the LaTeX distribution (this can take a few minutes)
tinytex::install_tinytex()
knitr::opts_chunk$set(echo = TRUE)
### load your data and create the madad object with 95% CI
setwd("~/Desktop/swab")
df <- read_excel("Outcome.xlsx")
library(readxl)
library(mada)
### load your data and create the madad object with 95% CI
setwd("~/Desktop/swab")
df <- read_excel("Outcome.xlsx")
meta <- madad(df, level = 0.95)
### load your data and create the madad object with 95% CI
setwd("~/Desktop/swab")
df <- read_excel("Outcome.xlsx")
meta <- madad(df, level = 0.95)
mada:::forest.madad(meta, type = "sens")
mada:::forest.madad(meta, type = "spec")
rs <- rowSums(df[,c(2,3,4,5)])
weights <- 4 * rs / max(rs)
crosshair(df, xlim = c(0,0.6), ylim = c(0.4,1),
col = 1:14, lwd = weights)
ROCellipse(df, pch = "")
points(fpr(df), sens(df))
library(mada)
# Original DSL
fit.DOR.DSL <- madauni(df, method = "DSL")
summary(fit.DOR.DSL)
# Leave-one-out sensitivity
loo_results <- sapply(1:nrow(df), function(i) {
temp_df <- df[-i, ]   # remove study i
fit <- madauni(temp_df, method = "DSL")
fit$DOR
})
names(loo_results) <- df$study  # optional: add study names
loo_results
library(mada)
# Original DSL
fit.DOR.DSL <- madauni(df, method = "DSL")
summary(fit.DOR.DSL)
# Leave-one-out sensitivity
loo_results <- sapply(1:nrow(df), function(i) {
temp_df <- df[-i, ]   # remove study i
fit <- madauni(temp_df, method = "DSL")
fit$DOR
})
names(loo_results) <- df$names  # optional: add study names
loo_results
loo_DSL <- sapply(1:nrow(df), function(i) {
temp <- df[-i, ]
fit <- madauni(temp, method = "DSL")
fit$DOR
})
names(loo_DSL) <- df$study
loo_DSL
loo_DSL <- sapply(1:nrow(df), function(i) {
temp <- df[-i, ]
fit <- madauni(temp, method = "DSL")
fit$DOR
})
names(loo_DSL) <- df$names
loo_DSL
# Example: compute DOR and log DOR per study
df$DOR <- (df$TP * df$TN) / (df$FP * df$FN)
df$lnDOR <- log(df$DOR)
loo_DSL <- sapply(1:nrow(df), function(i) {
temp <- df[-i, ]
fit <- madauni(temp, method = "DSL")
fit$DOR
})
names(loo_DSL) <- df$names
loo_DSL
# Example: compute DOR and log DOR per study
df$DOR <- (df$TP * df$TN) / (df$FP * df$FN)
df$lnDOR <- log(df$DOR)
loo_DSL <- sapply(1:nrow(df), function(i) {
temp <- df[-i, ]
fit <- madauni(temp, method = "DSL")
fit$DOR
})
names(loo_DSL) <- df$names
loo_DSL
# Example: compute DOR and log DOR per study
df$DOR <- (df$TP * df$TN) / (df$FP * df$FN)
df$lnDOR <- log(df$DOR)
loo_DSL <- sapply(1:nrow(df), function(i) {
temp <- df[-i, ]
fit <- madauni(temp, method = "DSL")
fit$DOR
})
names(loo_DSL) <- df$names
loo_DSL
df$DOR <- (df$TP * df$TN) / (df$FP * df$FN)  # study-level DOR
df$lnDOR <- log(df$DOR)                       # log DOR
df
df$DOR <- (df$TP * df$TN) / (df$FP * df$FN)  # study-level DOR
df$lnDOR <- log(df$DOR)                       # log DOR
df
loo_DSL <- sapply(1:nrow(df), function(i) {
temp <- df[-i, ]                # remove study i
fit <- madauni(temp, method="DSL")
fit$DOR                        # pooled DOR without study i
})
names(loo_DSL) <- df$study
loo_DSL
common_vars
setwd("~/GCC")
library(tidyverse)
# Bahrain
bahrain_2002 <- read_csv(
"~/GCC/GCC Data/Bahrain/CSV/BAHRAIN2002.csv",
show_col_types = FALSE
) |> mutate(country = "Bahrain", year = 2002)
bahrain_2015 <- read_csv(
"~/GCC/GCC Data/Bahrain/CSV/BAHRAIN2015.csv",
show_col_types = FALSE
) |> mutate(country = "Bahrain", year = 2015)
# Kuwait
kuwait_2001 <- read_csv(
"~/GCC/GCC Data/Kuwait/CSV/KUWAIT 2001.csv",
show_col_types = FALSE
) |> mutate(country = "Kuwait", year = 2001)
kuwait_2005 <- read_csv(
"~/GCC/GCC Data/Kuwait/CSV/KUWAIT2005.csv",
show_col_types = FALSE
) |> mutate(country = "Kuwait", year = 2005)
kuwait_2009 <- read_csv(
"~/GCC/GCC Data/Kuwait/CSV/KUWAIT2009.csv",
show_col_types = FALSE
) |> mutate(country = "Kuwait", year = 2009)
kuwait_2016 <- read_csv(
"~/GCC/GCC Data/Kuwait/CSV/KUWAIT2016.csv",
show_col_types = FALSE
) |> mutate(country = "Kuwait", year = 2016)
# Oman
oman_2002 <- read_csv(
"~/GCC/GCC Data/Oman/CSV/OMAN2002.csv",
show_col_types = FALSE
) |> mutate(country = "Oman", year = 2002)
oman_2007 <- read_csv(
"~/GCC/GCC Data/Oman/CSV/OMAN2007.csv",
show_col_types = FALSE
) |> mutate(country = "Oman", year = 2007)
oman_2010 <- read_csv(
"~/GCC/GCC Data/Oman/CSV/OMAN2010.csv",
show_col_types = FALSE
) |> mutate(country = "Oman", year = 2010)
oman_2016 <- read_csv(
"~/GCC/GCC Data/Oman/CSV/OMAN2016.csv",
show_col_types = FALSE
) |> mutate(country = "Oman", year = 2016)
# Qatar
qatar_2004 <- read_csv(
"~/GCC/GCC Data/Qatar/CSV/QATAR2004.csv",
show_col_types = FALSE
) |> mutate(country = "Qatar", year = 2004)
qatar_2007 <- read_csv(
"~/GCC/GCC Data/Qatar/CSV/QATAR2007.csv",
show_col_types = FALSE
) |> mutate(country = "Qatar", year = 2007)
qatar_2013 <- read_csv(
"~/GCC/GCC Data/Qatar/CSV/QATAR2013.csv",
show_col_types = FALSE
) |> mutate(country = "Qatar", year = 2013)
qatar_2018 <- read_csv(
"~/GCC/GCC Data/Qatar/CSV/QATAR2018.csv",
show_col_types = FALSE
) |> mutate(country = "Qatar", year = 2018)
# Saudi Arabia
saudi_2001 <- read_csv(
"~/GCC/GCC Data/Saudi/CSV/SAU2001.csv",
show_col_types = FALSE
) |> mutate(country = "Saudi Arabia", year = 2001)
saudi_2007 <- read_csv(
"~/GCC/GCC Data/Saudi/CSV/SAU2007.csv",
show_col_types = FALSE
) |> mutate(country = "Saudi Arabia", year = 2007)
saudi_2010 <- read_csv(
"~/GCC/GCC Data/Saudi/CSV/SAU2010.csv",
show_col_types = FALSE
) |> mutate(country = "Saudi Arabia", year = 2010)
saudi_2022 <- read_csv(
"~/GCC/GCC Data/Saudi/CSV/SAU2022.csv",
show_col_types = FALSE
) |> mutate(country = "Saudi Arabia", year = 2022)
# UAE
uae_2002 <- read_csv(
"~/GCC/GCC Data/UAE/CSV/UNITEDARABEMIRATES2002.csv",
show_col_types = FALSE
) |> mutate(country = "UAE", year = 2002)
uae_2005 <- read_csv(
"~/GCC/GCC Data/UAE/CSV/UNITEDARABEMIRATES2005.csv",
show_col_types = FALSE
) |> mutate(country = "UAE", year = 2005)
uae_2013 <- read_csv(
"~/GCC/GCC Data/UAE/CSV/UNITEDARABEMIRATES2013.csv",
show_col_types = FALSE
) |> mutate(country = "UAE", year = 2013)
kuwait_2001$FinalWgt <- kuwait_2001$finalwgt
uae_2002$FinalWgt <-uae_2002$finalwgt
sapply(all_data, function(df) "FinalWgt" %in% names(df))
kuwait_2001$FinalWgt <- kuwait_2001$finalwgt
uae_2002$FinalWgt <-uae_2002$finalwgt
all_data <- list(
bahrain_2002, bahrain_2015,
kuwait_2001, kuwait_2005, kuwait_2009, kuwait_2016,
oman_2002, oman_2007, oman_2010, oman_2016,
qatar_2004, qatar_2007, qatar_2013, qatar_2018,
saudi_2001, saudi_2007, saudi_2010, saudi_2022,
uae_2002, uae_2005, uae_2013
)
common_vars <- Reduce(
intersect,
lapply(all_data, names)
)
length(common_vars)
common_vars
all_data_common <- lapply(all_data, function(df) {
df |> select(all_of(common_vars))
})
View(all_data_common)
all_data_common
common_vars
library(survey)
install.packages("surve")
install.packages("survey")
library(survey)
gcc_common <- bind_rows(all_data_common)
gcc_common <- gcc_common |>
mutate(
PSU = interaction(country, year, PSU, drop = TRUE),
Stratum = interaction(country, year, Stratum, drop = TRUE)
)
gcc_common
gcc_design <- svydesign(
id = ~PSU,
strata = ~Stratum,
weights = ~FinalWgt,
data = gcc_common,
nest = TRUE
)
gcc_design
summary(gcc_design)
svymean(~CR1, gcc_design, na.rm = TRUE)
cr_vars <- c("CR1","CR2","CR14","CR16","CR31","CR32","CR33",
"CR34","CR35","CR41","CR42")
cr_vars
library(dplyr)
library(survey)
# Initialize empty list to store results
results_list <- list()
for (var in cr_vars) {
# svyby computes survey means by grouping variables
tab <- svyby(
formula = as.formula(paste0("~", var)),
by = ~country + year,
design = gcc_design,
FUN = svymean,
na.rm = TRUE
)
# Add a variable column to identify which CR variable this is
tab <- tab %>% mutate(variable = var)
# Store
results_list[[var]] <- tab
}
# Combine all CR variables into one table
cr_summary <- bind_rows(results_list)
cr_summary
view(gcc_common)
library(tidyr)
cr_summary_wide <- cr_summary %>%
select(country, year, variable, everything()) %>%
pivot_wider(
names_from = variable,
values_from = c(!!cr_vars, paste0(cr_vars, "_SE")),
names_sep = "_"
)
cr_summary <- map_dfr(cr_vars, function(var) {
# svyby to compute mean and SE for each country-year
svyby(
formula = as.formula(paste0("~", var)),
by = ~country + year,
design = gcc_design,
FUN = svymean,
na.rm = TRUE
) %>%
# tidy the output
as_tibble() %>%
rename(mean = !!var, SE = paste0(var, ".se")) %>%
mutate(variable = var) %>%
select(country, year, variable, mean, SE)
})
library(dplyr)
library(purrr)
library(survey)
cr_vars <- c("CR1","CR2","CR14","CR16","CR31","CR32","CR33",
"CR34","CR35","CR41","CR42")
cr_summary <- map_dfr(cr_vars, function(var) {
tab <- svyby(
formula = as.formula(paste0("~", var)),
by = ~country + year,
design = gcc_design,
FUN = svymean,
na.rm = TRUE,
keep.names = TRUE
)
# Extract mean and SE reliably
tab <- tab %>%
as_tibble() %>%
mutate(
mean = tab[[var]],
SE   = SE(tab[[var]])
) %>%
select(country, year, mean, SE) %>%
mutate(variable = var) %>%
select(country, year, variable, mean, SE)
return(tab)
})
library(dplyr)
library(purrr)
library(survey)
library(tidyr)
cr_vars <- c("CR1","CR2","CR14","CR16","CR31","CR32","CR33",
"CR34","CR35","CR41","CR42")
# Compute for each variable and bind into one long table
cr_summary <- map_dfr(cr_vars, function(var) {
tab <- svyby(
as.formula(paste0("~", var)),
by = ~country + year,
design = gcc_design,
FUN = svymean,
na.rm = TRUE
)
# Convert to tibble and rename columns reliably
tab <- tab %>%
as_tibble() %>%
rename_with(~c("country","year","mean","SE"), .cols = c(1,2,3,4)) %>%
mutate(variable = var) %>%
select(country, year, variable, mean, SE)
return(tab)
})
cr_summary
cr_summary_wide <- cr_summary %>%
pivot_wider(
names_from = variable,
values_from = c(mean, SE),
names_glue = "{variable}_{.value}"
)
cr_summary_wide
library(dplyr)
# Identify all CR variables
cr_vars <- c("CR1","CR2","CR14","CR16","CR31","CR32","CR33",
"CR34","CR35","CR41","CR42")
# Add 95% CI columns
cr_summary_wide <- cr_summary_wide %>%
mutate(across(all_of(cr_vars), .fns = list(
LCI = ~ . - 1.96 * get(paste0(cur_column(), "_SE")),
UCI = ~ . + 1.96 * get(paste0(cur_column(), "_SE"))
), .names = "{.col}_{.fn}"))
# Identify mean columns
mean_cols <- paste0(cr_vars, "_mean")
# Add LCI and UCI
cr_summary_wide <- cr_summary_wide %>%
mutate(across(all_of(mean_cols),
.fns = list(
LCI = ~ . - 1.96 * get(sub("_mean$", "_SE", cur_column())),
UCI = ~ . + 1.96 * get(sub("_mean$", "_SE", cur_column()))
),
.names = "{.col}_{.fn}"
))
cr_summary_wide
View(cr_summary_wide)
library(ggplot2)
library(tidyr)
cr_long <- cr_summary_wide %>%
pivot_longer(
cols = starts_with("CR"),
names_to = c("variable", ".value"),
names_pattern = "(CR\\d+)_?(mean|SE|LCI|UCI)?"
)
cr_long
ggplot(cr_long, aes(x = factor(year), y = mean, color = country, group = country)) +
geom_point() +
geom_line() +
geom_errorbar(aes(ymin = LCI, ymax = UCI), width = 0.2) +
facet_wrap(~variable, scales = "free_y") +
labs(x = "Year", y = "Weighted Mean", title = "Survey Means of CR Variables by Country and Year") +
theme_minimal()
cr_long <- cr_summary_wide %>%
pivot_longer(
cols = starts_with("CR"),
names_to = c("variable", ".value"),
names_pattern = "(CR\\d+)_?(mean|SE|LCI|UCI)?"
)
# Select relevant columns
cr_long <- cr_summary_wide %>%
pivot_longer(
cols = starts_with("CR"),
names_to = c("variable", "stat"),
names_sep = "_",
values_to = "value"
) %>%
pivot_wider(
names_from = stat,
values_from = value
)
ggplot(cr_long, aes(x = factor(year), y = mean, color = country, group = country)) +
geom_point() +
geom_line() +
geom_errorbar(aes(ymin = LCI, ymax = UCI), width = 0.2) +
facet_wrap(~variable, scales = "free_y") +
labs(x = "Year", y = "Weighted Mean", title = "Survey Means of CR Variables by Country and Year") +
theme_minimal()
cr_long <- cr_summary_wide %>%
pivot_longer(
cols = matches("^CR\\d+_"),
names_to = c("variable", "stat"),
names_pattern = "(CR\\d+)_(mean|SE|mean_LCI|mean_UCI)"
) %>%
# Make proper column names
mutate(stat = recode(stat,
"mean" = "mean",
"SE" = "SE",
"mean_LCI" = "LCI",
"mean_UCI" = "UCI")) %>%
pivot_wider(names_from = stat, values_from = value)
library(ggplot2)
ggplot(cr_long, aes(x = factor(year), y = mean, color = country, group = country)) +
geom_point() +
geom_line() +
geom_errorbar(aes(ymin = LCI, ymax = UCI), width = 0.2) +
facet_wrap(~variable, scales = "free_y") +
labs(x = "Year", y = "Weighted Mean",
title = "Survey Means of CR Variables by Country and Year") +
theme_minimal()
library(tidyr)
library(dplyr)
library(ggplot2)
cr_long <- cr_summary_wide %>%
pivot_longer(
cols = matches("^CR\\d+_"),
names_to = c("variable", "stat"),
names_pattern = "(CR\\d+)_(mean|SE|mean_LCI|mean_UCI)"
) %>%
mutate(stat = recode(stat,
"mean" = "mean",
"SE" = "SE",
"mean_LCI" = "LCI",
"mean_UCI" = "UCI")) %>%
pivot_wider(names_from = stat, values_from = value) %>%
unnest(cols = c(mean, SE, LCI, UCI))  # flatten list-columns into numeric
head(cr_summary_wide)
cr_long <- cr_summary_wide %>%
pivot_longer(
cols = matches("^CR\\d+_"),       # all CR-related columns
names_to = c("variable", "stat"), # split into variable and statistic
names_pattern = "(CR\\d+)_(.*)"   # everything after CR\d+_ goes into stat
) %>%
pivot_wider(
names_from = stat,
values_from = value
)
cr_long
cr_long <- cr_long %>%
rename(
LCI = mean_LCI,
UCI = mean_UCI
)
cr_long
library(ggplot2)
ggplot(cr_long, aes(x = factor(year), y = mean, color = country, group = country)) +
geom_point() +
geom_line() +
geom_errorbar(aes(ymin = LCI, ymax = UCI), width = 0.2) +
facet_wrap(~variable, scales = "free_y") +
labs(x = "Year", y = "Weighted Mean",
title = "Survey Means of CR Variables by Country and Year") +
theme_minimal()
cr_plot <- ggplot(cr_long, aes(x = factor(year), y = mean, color = country, group = country)) +
geom_point() +
geom_line() +
geom_errorbar(aes(ymin = LCI, ymax = UCI), width = 0.2) +
facet_wrap(~variable, scales = "free_y") +
labs(x = "Year", y = "Weighted Mean",
title = "Survey Means of CR Variables by Country and Year") +
theme_minimal()
# Display the plot
cr_plot
ggsave(filename = "CR_variables_plot.png", plot = cr_plot, width = 16, height = 10, dpi = 300)
ggsave(filename = "CR_variables_plot.png", plot = cr_plot, width = 20, height = 12, dpi = 300)
library(writexl)
# Save wide table
write_xlsx(cr_summary_wide, path = "CR_summary_wide.xlsx")
