) |> mutate(country = "Kuwait", year = 2016)
# Oman
oman_2016 <- read_csv(
"~/GCC/GCC Data/Oman/CSV/OMAN2016.csv",
show_col_types = FALSE
) |> mutate(country = "Oman", year = 2016)
# Qatar
qatar_2018 <- read_csv(
"~/GCC/GCC Data/Qatar/CSV/QATAR2018.csv",
show_col_types = FALSE
) |> mutate(country = "Qatar", year = 2018)
# Saudi Arabia
saudi_2022 <- read_csv(
"~/GCC/GCC Data/Saudi/CSV/SAU2022.csv",
show_col_types = FALSE
) |> mutate(country = "Saudi Arabia", year = 2022)
# UAE
uae_2013 <- read_csv(
"~/GCC/GCC Data/UAE/CSV/UNITEDARABEMIRATES2013.csv",
show_col_types = FALSE
) |> mutate(country = "UAE", year = 2013)
all_data <- c(
"bahrain_2002","bahrain_2015",
"kuwait_2001", "kuwait_2005", "kuwait_2009", "kuwait_2016",
"oman_2002", "oman_2007", "oman_2010", "oman_2016",
"qatar_2004", "qatar_2007", "qatar_2013", "qatar_2018",
"saudi_2001", "saudi_2007", "saudi_2010", "saudi_2022",
"uae_2002", "uae_2005", "uae_2013"
)
common_vars <- Reduce(
intersect,
lapply(all_data, names)
)
filtered_data_list <- lapply(all_data, function(df_name) {
df <- get(df_name)            # get the actual dataset by name
df %>% select(all_of(common_vars))
})
names(filtered_data_list) <- all_data
library(tidyverse)
library(dplyr)
library(purrr)
library(survey)
library(tidyr)
library(writexl)
library(ggplot2)
setwd("~/GCC")
# Bahrain
bahrain_2015 <- read_csv(
"~/GCC/GCC Data/Bahrain/CSV/BAHRAIN2015.csv",
show_col_types = FALSE
) |> mutate(country = "Bahrain", year = 2015)
# Kuwait
kuwait_2016 <- read_csv(
"~/GCC/GCC Data/Kuwait/CSV/KUWAIT2016.csv",
show_col_types = FALSE
) |> mutate(country = "Kuwait", year = 2016)
# Oman
oman_2016 <- read_csv(
"~/GCC/GCC Data/Oman/CSV/OMAN2016.csv",
show_col_types = FALSE
) |> mutate(country = "Oman", year = 2016)
# Qatar
qatar_2018 <- read_csv(
"~/GCC/GCC Data/Qatar/CSV/QATAR2018.csv",
show_col_types = FALSE
) |> mutate(country = "Qatar", year = 2018)
# Saudi Arabia
saudi_2022 <- read_csv(
"~/GCC/GCC Data/Saudi/CSV/SAU2022.csv",
show_col_types = FALSE
) |> mutate(country = "Saudi Arabia", year = 2022)
# UAE
uae_2013 <- read_csv(
"~/GCC/GCC Data/UAE/CSV/UNITEDARABEMIRATES2013.csv",
show_col_types = FALSE
) |> mutate(country = "UAE", year = 2013)
#
all_data <- c(
"bahrain_2002","bahrain_2015",
"kuwait_2001", "kuwait_2005", "kuwait_2009", "kuwait_2016",
"oman_2002", "oman_2007", "oman_2010", "oman_2016",
"qatar_2004", "qatar_2007", "qatar_2013", "qatar_2018",
"saudi_2001", "saudi_2007", "saudi_2010", "saudi_2022",
"uae_2002", "uae_2005", "uae_2013"
)
common_vars <- Reduce(
intersect,
lapply(all_data, names)
)
filtered_data_list <- lapply(all_data, function(df_name) {
df <- get(df_name)            # get the actual dataset by name
df %>% select(all_of(common_vars))
})
names(filtered_data_list) <- all_data
library(tidyverse)
library(dplyr)
library(purrr)
library(survey)
library(tidyr)
library(writexl)
library(ggplot2)
# Bahrain
bahrain_2015 <- read_csv(
"~/GCC/GCC Data/Bahrain/CSV/BAHRAIN2015.csv",
show_col_types = FALSE
) |> mutate(country = "Bahrain", year = 2015)
# Kuwait
kuwait_2016 <- read_csv(
"~/GCC/GCC Data/Kuwait/CSV/KUWAIT2016.csv",
show_col_types = FALSE
) |> mutate(country = "Kuwait", year = 2016)
# Oman
oman_2016 <- read_csv(
"~/GCC/GCC Data/Oman/CSV/OMAN2016.csv",
show_col_types = FALSE
) |> mutate(country = "Oman", year = 2016)
# Qatar
qatar_2018 <- read_csv(
"~/GCC/GCC Data/Qatar/CSV/QATAR2018.csv",
show_col_types = FALSE
) |> mutate(country = "Qatar", year = 2018)
# Saudi Arabia
saudi_2022 <- read_csv(
"~/GCC/GCC Data/Saudi/CSV/SAU2022.csv",
show_col_types = FALSE
) |> mutate(country = "Saudi Arabia", year = 2022)
# UAE
uae_2013 <- read_csv(
"~/GCC/GCC Data/UAE/CSV/UNITEDARABEMIRATES2013.csv",
show_col_types = FALSE
) |> mutate(country = "UAE", year = 2013)
#
kuwait_2001$FinalWgt <- kuwait_2001$finalwgt
library(tidyverse)
library(dplyr)
library(purrr)
library(survey)
library(tidyr)
library(writexl)
library(ggplot2)
# Bahrain
bahrain_2015 <- read_csv(
"~/GCC/GCC Data/Bahrain/CSV/BAHRAIN2015.csv",
show_col_types = FALSE
) |> mutate(country = "Bahrain", year = 2015)
# Kuwait
kuwait_2016 <- read_csv(
"~/GCC/GCC Data/Kuwait/CSV/KUWAIT2016.csv",
show_col_types = FALSE
) |> mutate(country = "Kuwait", year = 2016)
# Oman
oman_2016 <- read_csv(
"~/GCC/GCC Data/Oman/CSV/OMAN2016.csv",
show_col_types = FALSE
) |> mutate(country = "Oman", year = 2016)
# Qatar
qatar_2018 <- read_csv(
"~/GCC/GCC Data/Qatar/CSV/QATAR2018.csv",
show_col_types = FALSE
) |> mutate(country = "Qatar", year = 2018)
# Saudi Arabia
saudi_2022 <- read_csv(
"~/GCC/GCC Data/Saudi/CSV/SAU2022.csv",
show_col_types = FALSE
) |> mutate(country = "Saudi Arabia", year = 2022)
# UAE
uae_2013 <- read_csv(
"~/GCC/GCC Data/UAE/CSV/UNITEDARABEMIRATES2013.csv",
show_col_types = FALSE
) |> mutate(country = "UAE", year = 2013)
all_data <- c(
"bahrain_2015",
"kuwait_2016",
"oman_2016",
"qatar_2018",
"saudi_2022",
"uae_2013"
)
common_vars <- Reduce(
intersect,
lapply(all_data, names)
)
# Use lapply to filter each dataset
filtered_data_list <- lapply(all_data, function(df_name) {
df <- get(df_name)            # get the actual dataset by name
df %>% select(all_of(common_vars))
})
# Name the list elements the same as the original datasets
names(filtered_data_list) <- all_data
filtered_data_list$bahrain_2015
data_list <- list(
bahrain_2015 = bahrain_2015,
kuwait_2016  = kuwait_2016,
oman_2016    = oman_2016,
qatar_2018   = qatar_2018,
saudi_2022  = saudi_2022,
uae_2013    = uae_2013
)
common_vars <- Reduce(intersect, lapply(data_list, names))
filtered_data_list <- lapply(data_list, function(df) {
df |> select(all_of(common_vars))
})
gcc_design <- svydesign(
id = ~PSU,
strata = ~Stratum,
weights = ~FinalWgt,
data = filtered_data_list$bahrain_2015,
nest = TRUE
)
gcc_design
cr33_prop <- svymean(~factor(CR33), gcc_design, na.rm = TRUE)
cr33_prop
common_vars
gcc_all <- bind_rows(filtered_data_list, .id = "dataset")
gcc_all
count(gcc_all, country, year)
gcc_design_all <- svydesign(
id = ~PSU,
strata = ~Stratum,
weights = ~FinalWgt,
data = gcc_all,
nest = TRUE
)
analysis_vars <- common_vars |>
setdiff(c("FinalWgt", "PSU", "Stratum", "country", "year"))
get_svy_props <- function(var, design) {
f <- as.formula(paste0("~factor(", var, ")"))
est <- svymean(f, design, na.rm = TRUE)
ci  <- confint(est)
tibble(
variable   = var,
level      = gsub(paste0("factor\\(", var, "\\)"), "", names(coef(est))),
proportion = as.numeric(coef(est)),
se         = as.numeric(SE(est)),
lci        = ci[, 1],
uci        = ci[, 2]
)
}
get_svy_props
all_results <- map_dfr(
analysis_vars,
get_svy_props,
design = gcc_design_all
)
all_results
write_xlsx(
all_results,
path = "GCC_all_variables_proportions.xlsx"
)
ggplot(all_results,
aes(x = level, y = proportion)) +
geom_col(width = 0.7) +
geom_errorbar(
aes(ymin = lci, ymax = uci),
width = 0.15
) +
facet_wrap(~ variable, scales = "free_x") +
scale_y_continuous(labels = scales::percent_format()) +
labs(
x = "Response level",
y = "Proportion",
title = "Survey-weighted proportions with 95% CI"
) +
theme_minimal() +
theme(
strip.text = element_text(size = 9),
axis.text.x = element_text(angle = 45, hjust = 1)
)
ggplot(cr33_by_country,
aes(x = country, y = `factor(CR33)1`)) +
geom_col(position = "dodge") +
geom_errorbar(
aes(
ymin = `ci_l.factor(CR33)1`,
ymax = `ci_u.factor(CR33)1`
),
width = 0.2
) +
scale_y_continuous(labels = scales::percent_format()) +
labs(
x = NULL,
y = "Proportion",
title = "CR33 (Yes): By country"
) +
theme_minimal()
ggplot(all_results_country,
aes(x = level, y = proportion, fill = country)) +
geom_col(
position = position_dodge(width = 0.8),
width = 0.7
) +
geom_errorbar(
aes(ymin = ci_l, ymax = ci_u),
position = position_dodge(width = 0.8),
width = 0.2
) +
facet_wrap(~ variable, scales = "free_x") +
scale_y_continuous(labels = scales::percent_format()) +
labs(
x = "Response level",
y = "Proportion",
fill = "Country",
title = "Survey-weighted proportions by country (95% CI)"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text = element_text(size = 9)
)
all_results_country <- map_dfr(
analysis_vars,
get_svy_props_by_country,
design = gcc_design_all
)
get_svy_props_by_country <- function(var, design) {
f <- as.formula(paste0("~factor(", var, ")"))
svyby(
f,
~country,
design,
svymean,
na.rm = TRUE,
vartype = c("se", "ci")
) |>
as_tibble() |>
pivot_longer(
cols = starts_with("factor"),
names_to = "level",
values_to = "proportion"
) |>
mutate(
variable = var,
level = gsub(paste0("factor\\(", var, "\\)"), "", level)
)
}
all_results_country <- map_dfr(
analysis_vars,
get_svy_props_by_country,
design = gcc_design_all
)
ggplot(all_results_country,
aes(x = level, y = proportion, fill = country)) +
geom_col(
position = position_dodge(width = 0.8),
width = 0.7
) +
geom_errorbar(
aes(ymin = ci_l, ymax = ci_u),
position = position_dodge(width = 0.8),
width = 0.2
) +
facet_wrap(~ variable, scales = "free_x") +
scale_y_continuous(labels = scales::percent_format()) +
labs(
x = "Response level",
y = "Proportion",
fill = "Country",
title = "Survey-weighted proportions by country (95% CI)"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text = element_text(size = 9)
)
all_results
library(ggplot2)
library(scales)
ggplot(all_results,
aes(x = level, y = proportion)) +
geom_col(width = 0.7, fill = "steelblue") +
geom_errorbar(
aes(ymin = lci, ymax = uci),
width = 0.2
) +
facet_wrap(~ variable, scales = "free_x") +
scale_y_continuous(labels = percent_format()) +
labs(
x = "Response category",
y = "Proportion",
title = "Survey-weighted proportions with 95% CI"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text = element_text(size = 9)
)
############################################
## Libraries
############################################
library(tidyverse)
library(survey)
library(scales)
library(ggplot2)
############################################
## 1. Read data and harmonize
############################################
bahrain_2015 <- read_csv(
"~/GCC/GCC Data/Bahrain/CSV/BAHRAIN2015.csv",
show_col_types = FALSE
) |> mutate(country = "Bahrain", year = 2015)
kuwait_2016 <- read_csv(
"~/GCC/GCC Data/Kuwait/CSV/KUWAIT2016.csv",
show_col_types = FALSE
) |> mutate(country = "Kuwait", year = 2016)
oman_2016 <- read_csv(
"~/GCC/GCC Data/Oman/CSV/OMAN2016.csv",
show_col_types = FALSE
) |> mutate(country = "Oman", year = 2016)
qatar_2018 <- read_csv(
"~/GCC/GCC Data/Qatar/CSV/QATAR2018.csv",
show_col_types = FALSE
) |> mutate(country = "Qatar", year = 2018)
saudi_2022 <- read_csv(
"~/GCC/GCC Data/Saudi/CSV/SAU2022.csv",
show_col_types = FALSE
) |> mutate(country = "Saudi Arabia", year = 2022)
uae_2013 <- read_csv(
"~/GCC/GCC Data/UAE/CSV/UNITEDARABEMIRATES2013.csv",
show_col_types = FALSE
) |> mutate(country = "UAE", year = 2013)
############################################
## 2. Combine datasets
############################################
all_data_list <- list(
bahrain_2015,
kuwait_2016,
oman_2016,
qatar_2018,
saudi_2022,
uae_2013
)
# Find common variables
common_vars <- Reduce(intersect, lapply(all_data_list, names))
# Keep only common variables
all_data <- all_data_list |>
map(~ select(.x, all_of(common_vars))) |>
bind_rows()
############################################
## 3. Survey design
############################################
options(survey.lonely.psu = "adjust")
gcc_design_all <- svydesign(
id = ~PSU,
strata = ~Stratum,
weights = ~FinalWgt,
data = all_data,
nest = TRUE
)
############################################
## 4. Function: proportions + CI by country
############################################
get_props_by_country <- function(var, design) {
f <- as.formula(paste0("~factor(", var, ")"))
res <- svyby(
f,
~country,
design,
svymean,
na.rm = TRUE,
vartype = "ci"
) |> as.data.frame()
mean_cols <- grep("^factor\\(", names(res), value = TRUE)
map_dfr(mean_cols, function(m) {
tibble(
variable   = var,
country    = res$country,
level      = gsub(paste0("factor\\(", var, "\\)"), "", m),
proportion = res[[m]],
lci        = res[[paste0("ci_l.", m)]],
uci        = res[[paste0("ci_u.", m)]]
)
})
}
############################################
## 5. Run for all common CR variables
############################################
analysis_vars <- setdiff(
common_vars,
c("FinalWgt", "PSU", "Stratum", "country", "year")
)
all_results_country <- map_dfr(
analysis_vars,
get_props_by_country,
design = gcc_design_all
)
############################################
## 6. Bar plots (colored by country)
############################################
ggplot(all_results_country,
aes(x = level, y = proportion, fill = country)) +
geom_col(
position = position_dodge(0.8),
width = 0.7
) +
geom_errorbar(
aes(ymin = lci, ymax = uci),
position = position_dodge(0.8),
width = 0.2
) +
facet_wrap(~ variable, scales = "free_x") +
scale_y_continuous(labels = percent_format()) +
labs(
x = "Response category",
y = "Proportion",
fill = "Country",
title = "Survey-weighted proportions by country (95% CI)"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text = element_text(size = 9)
)
